#!/usr/bin/env python-sirius

import matplotlib.pyplot as plt
import numpy as np


def correct_excdata(plot=True):

    # M1
    # QS-02_K_BOB_000.0A_210209_165915.dat
    # QS-02_K_BOB_002.0A_210209_165943.dat
    # QS-02_K_BOB_004.0A_210209_170012.dat
    # QS-02_K_BOB_006.0A_210209_170040.dat
    # QS-02_K_BOB_008.8A_210209_170107.dat
    # QS-02_K_BOB_006.0A_210209_170135.dat
    # QS-02_K_BOB_004.0A_210209_170203.dat
    # QS-02_K_BOB_002.0A_210209_170231.dat
    # QS-02_K_BOB_000.0A_210209_170258.dat
    # QS-02_K_BOB_-02.0A_210209_170326.dat
    # QS-02_K_BOB_-04.0A_210209_170354.dat
    # QS-02_K_BOB_-06.0A_210209_170422.dat
    # QS-02_K_BOB_-08.8A_210209_170450.dat
    # QS-02_K_BOB_-06.0A_210209_170520.dat
    # QS-02_K_BOB_-04.0A_210209_170551.dat
    # QS-02_K_BOB_-02.0A_210209_170619.dat
    # QS-02_K_BOB_000.0A_210209_170648.dat

    # excdata M1
    excdata_m1 = np.array([
        [+0000.00, -8.262560e-06, -6.586226e-06, -6.996075e-06, -2.183196e-04, +1.258785e-03, +2.501166e-04, -1.563972e-02, +7.633910e-02, -1.698685e+00, +7.909819e-01, -7.612613e+01, -1.517939e+02, +3.769997e+03, -1.360459e+03, +1.938415e+05, +1.625703e+05, -3.128819e+07, -2.722379e+07, -2.191116e+09, -2.314048e+09,],
        [+0002.00, -7.885514e-06, -5.402474e-06, -5.670326e-05, -3.780890e-02, +1.076085e-04, +6.124825e-04, -2.335334e-02, +1.172439e-01, -1.311476e+00, +4.007313e-01, -4.874378e+01, -1.887183e+03, -9.135531e+03, -1.497090e+03, -1.965198e+04, -5.271534e+05, +2.705052e+07, +1.266276e+07, +1.043094e+09, -3.692309e+09,],
        [+0004.00, -7.760932e-06, -4.229759e-06, -1.046311e-04, -7.587655e-02, -5.217490e-04, +1.181081e-03, -4.268174e-02, +1.190491e-01, -2.672840e+00, +9.997364e-02, -1.397968e+02, -3.931590e+03, +7.806394e+03, -1.401689e+04, +8.015543e+05, -2.805176e+04, -4.243377e+07, +9.384911e+06, +5.969421e+08, -1.178056e+10,],
        [+0006.00, -7.601023e-06, -2.809804e-06, -1.644069e-04, -1.141230e-01, -9.618521e-04, +9.639683e-04, -5.404484e-02, +7.853159e-02, -5.687379e-01, -1.232287e+00, -5.986007e+01, -6.279940e+03, -3.803749e+03, -6.582479e+03, +3.814058e+05, -1.884760e+06, +7.776533e+05, +1.745035e+07, -2.193926e+09, -1.142287e+10,],
        [+0008.80, -7.483889e-06, -1.171164e-06, -2.425615e-04, -1.676952e-01, -1.495027e-03, +1.915663e-03, -9.132956e-02, +9.021890e-02, -1.962334e+00, +3.581741e-01, -6.743772e-02, -9.019305e+03, -5.512120e+03, +8.824915e+03, +4.067251e+05, -2.336104e+05, +1.963539e+07, -1.439526e+07, -4.423676e+08, -2.734978e+10,],
    ])

    # M2
    # QS-02_K_BOB_000.0A_210209_194820.dat
    # QS-02_K_BOB_002.0A_210209_194847.dat
    # QS-02_K_BOB_004.0A_210209_194918.dat
    # QS-02_K_BOB_006.0A_210209_194945.dat
    # QS-02_K_BOB_008.8A_210209_195013.dat
    # QS-02_K_BOB_006.0A_210209_195041.dat
    # QS-02_K_BOB_004.0A_210209_195108.dat
    # QS-02_K_BOB_002.0A_210209_195136.dat
    # QS-02_K_BOB_000.0A_210209_195204.dat
    # QS-02_K_BOB_-02.0A_210209_195232.dat
    # QS-02_K_BOB_-04.0A_210209_195259.dat
    # QS-02_K_BOB_-06.0A_210209_195328.dat
    # QS-02_K_BOB_-08.8A_210209_195356.dat
    # QS-02_K_BOB_-06.0A_210209_195424.dat
    # QS-02_K_BOB_-04.0A_210209_195451.dat
    # QS-02_K_BOB_-02.0A_210209_195520.dat
    # QS-02_K_BOB_000.0A_210209_195550.dat
    excdata_m2 = np.array([
        [+0000.00, -8.200964e-06, -6.536913e-06, -2.845996e-06, -2.030902e-04, +1.013912e-03, +7.584741e-05, +1.636464e-02, +6.375851e-02, -7.188285e-01, -1.616668e+00, +7.366377e+01, +1.957828e+01, +4.077818e+03, -1.110699e+04, +1.090544e+05, +7.783191e+05, -3.023352e+07, -1.338115e+07, -1.031603e+09, +1.715362e+09, ],
        [+0002.00, -7.745373e-06, -5.411818e-06, -5.657935e-05, -3.779390e-02, +1.281183e-04, +6.158018e-04, -5.894717e-03, +7.303527e-02, -9.288813e-01, +3.433161e-01, -4.357957e+01, -1.866268e+03, +3.571252e+02, +2.884807e+03, -7.279522e+04, -1.875390e+05, -1.636307e+07, +3.008657e+07, -1.005448e+09, -4.176270e+09, ],
        [+0004.00, -7.571655e-06, -4.034189e-06, -1.077876e-04, -7.586000e-02, -4.731085e-04, +7.105072e-04, -3.664467e-02, +1.176742e-01, -5.022722e-01, -1.396133e+00, +3.359871e+01, -3.958278e+03, -6.794350e+03, +4.072958e+03, +7.242281e+05, -2.858099e+05, -5.859520e+05, +1.511995e+07, -9.111264e+08, -9.002003e+09, ],
        [+0006.00, -7.470970e-06, -2.904396e-06, -1.656463e-04, -1.141116e-01, -9.721077e-04, +1.542048e-03, -6.470080e-02, +5.200581e-02, -3.885782e-01, +6.882087e-01, -7.358502e+01, -6.227763e+03, -4.477203e+03, +5.861503e+03, -1.156299e+05, -1.337587e+06, +1.828948e+06, -2.690259e+07, -1.288930e+09, -1.488746e+10, ],
        [+0008.80, -7.315958e-06, -1.144315e-06, -2.412908e-04, -1.676976e-01, -1.586755e-03, +2.416628e-03, -8.876067e-02, +8.102311e-02, -2.254582e+00, -3.449776e-01, -6.850187e+01, -8.931439e+03, -8.665605e+03, +1.354677e+03, +3.598570e+04, -2.459439e+05, +1.056447e+07, -2.406640e+07, +2.302217e+09, -3.025490e+10, ],
    ])

    # M3
    # QS-02_K_BOB_000.0A_210209_205752.dat
    # QS-02_K_BOB_002.0A_210209_205819.dat
    # QS-02_K_BOB_004.0A_210209_205849.dat
    # QS-02_K_BOB_006.0A_210209_205916.dat
    # QS-02_K_BOB_008.8A_210209_205944.dat
    # QS-02_K_BOB_006.0A_210209_210012.dat
    # QS-02_K_BOB_004.0A_210209_210039.dat
    # QS-02_K_BOB_002.0A_210209_210109.dat
    # QS-02_K_BOB_000.0A_210209_210137.dat
    # QS-02_K_BOB_-02.0A_210209_210204.dat
    # QS-02_K_BOB_-04.0A_210209_210232.dat
    # QS-02_K_BOB_-06.0A_210209_210301.dat
    # QS-02_K_BOB_-08.8A_210209_210330.dat
    # QS-02_K_BOB_-06.0A_210209_210358.dat
    # QS-02_K_BOB_-04.0A_210209_210425.dat
    # QS-02_K_BOB_-02.0A_210209_210453.dat
    # QS-02_K_BOB_000.0A_210209_210522.dat
    excdata_m3 = np.array([
        [+0000.00, -8.165967e-06, -6.469029e-06, +4.886752e-07, -1.920961e-04, +9.117379e-04, -1.259695e-04, +1.673896e-02, +8.461546e-02, -6.969289e-01, -5.682630e-01, -2.346209e+01, -4.507022e+01, +4.581768e+03, +8.005095e+03, -1.831697e+04, +6.676271e+05, -8.087957e+06, +2.295514e+07, +1.670071e+09, -7.959736e+07, ],
        [+0002.00, -7.779753e-06, -5.223307e-06, -5.860305e-05, -3.778403e-02, +4.699605e-05, +5.618703e-04, +9.266764e-04, +9.944440e-02, +6.900736e-01, +8.641625e-01, -5.072660e+01, -1.830268e+03, -2.254580e+03, +7.473938e+03, -3.333246e+04, +4.419680e+05, -2.706645e+07, +7.061720e+06, -6.858757e+08, -3.422352e+09, ],
        [+0004.00, -7.539446e-06, -4.060941e-06, -1.074495e-04, -7.584973e-02, -6.378163e-04, +7.401775e-04, -2.909457e-02, +1.145275e-01, -8.301110e-01, -1.649157e+00, +1.618330e+01, -3.852704e+03, -5.509022e+02, +2.024596e+03, +1.292907e+05, -1.108173e+06, +1.160486e+07, -3.646554e+07, -8.025284e+08, -5.107726e+09, ],
        [+0006.00, -7.473958e-06, -2.848675e-06, -1.641549e-04, -1.141067e-01, -9.652416e-04, +1.339001e-03, -4.137014e-02, +4.818708e-02, -2.069965e+00, +1.518416e+00, +3.028271e+01, -6.246295e+03, -5.426496e+03, +3.673634e+03, -1.139364e+05, -1.744394e+06, +4.958967e+07, -2.443057e+07, -1.067130e+09, -1.603614e+10, ],
        [+0008.80, -7.442215e-06, -1.130139e-06, -2.336378e-04, -1.676812e-01, -1.330594e-03, +2.150315e-03, -7.685303e-02, +5.097729e-02, -1.811685e+00, +7.604854e-01, -4.302493e+01, -9.083469e+03, -9.470804e+03, +1.940296e+03, +6.521187e+04, -1.983461e+05, +6.902482e+06, +2.104696e+07, -2.564566e+09, -2.715676e+10, ],
    ])

    # measuaremets were taken wit inverted polariry w.r.t. convention
    excdata_m1[:, 1:] *= -1
    excdata_m2[:, 1:] *= -1
    excdata_m3[:, 1:] *= -1


    plt.plot(excdata_m1[:, 0], excdata_m1[:, 4], 'o-', label='M1')
    plt.plot(excdata_m2[:, 0], excdata_m2[:, 4], 'o-', label='M2')
    plt.plot(excdata_m3[:, 0], excdata_m3[:, 4], 'o-', label='M3')
    plt.xlabel('Current [A]')
    plt.ylabel('GL [T.m]')
    plt.title('BO QS-02 Integrated Skew Quadrupole')
    plt.legend()
    plt.grid()
    plt.show()

    excdata = (excdata_m1 + excdata_m2 + excdata_m3) / 3

    # # test linear extrapolation
    # poly = np.polyfit(excdata[-2:, 0], excdata[-2:, 4], 1)
    # fit1 = np.polyval(poly, 10)
    # poly = np.polyfit(excdata[:, 0], excdata[:, 4], 3)
    # fit2 = np.polyval(poly, 10)
    # print(fit1, fit2, 100*(fit1 - fit2)/fit2)

    for datum in reversed(excdata[1:]):
        curr, *mpoles = datum
        mpoles = np.array(mpoles)
        corr = 1
        mpoles *= corr
        print('{:+08.2f}  '.format(-curr), end='')
        for i in range(len(mpoles)//2):
            print('{:+.6e} {:+.6e}  '.format(-mpoles[2*i+0], -mpoles[2*i+1]), end='')
        print()

    for datum in excdata[1:]:
        curr, *mpoles = datum
        mpoles = np.array(mpoles)
        corr = 1
        mpoles *= corr
        print('{:+08.2f}  '.format(curr), end='')
        for i in range(len(mpoles)//2):
            print('{:+.6e} {:+.6e}  '.format(mpoles[2*i+0], mpoles[2*i+1]), end='')
        print()


correct_excdata(plot=True)
